update-package Microsoft.CodeDom.Providers.DotNetCompilerPlatform  -> Corregir error de ruta.


CREATE TABLE Country 
(Id int identity(1,1) Primary key ,
Name varchar(255),
Active int default 1,
unique(Name)
)

go

CREATE PROCEDURE [dbo].[SP_ListCountry]
AS
BEGIN
	SELECT Id, Name FROM Country WHERE Active = 1 order by Name Asc
END

go

CREATE TABLE Users 
(Id int identity(1,1) Primary key ,
Email varchar(255),
UserKey varchar(255),
Password varchar(255),
DateCreate datetime,
Active int default 1,
unique(Email)
)

go
CREATE PROCEDURE [dbo].[SP_Register] @Email varchar(255), @Password varchar(255), 
@Result varchar(max) OUTPUT
AS
BEGIN
	DECLARE @ExistEmail int, @PasswordMD5 varchar(255), @UserKey varchar(255)
	SELECT @ExistEmail = COUNT(1) FROM Users WHERE Email = @Email
	SELECT @PasswordMD5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Password ), 2)
	SELECT @UserKey = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Email ), 2)

	IF @ExistEmail = 1
		BEGIN
			SET @Result = 'Error__El Correo Ingresado ya Existe'
		END
	ELSE
		BEGIN
			INSERT INTO Users(Email,UserKey,Password,DateCreate)VALUES(LOWER(@Email),@UserKey,@PasswordMD5,GETDATE())
			INSERT INTO PersonalInformation(IdUser,	Email, UserImage)VALUES(@@IDENTITY, @Email, '/Resources/ImagesUsers/Usuario.png')
			SET @Result = 'OK__Su registro fue Existoso'
		END
	SELECT @Result
END

go

CREATE PROCEDURE [dbo].[SP_UserLogin] @Email varchar(255), @Password varchar(255), @Result varchar(max) OUTPUT
AS
BEGIN
DECLARE @ExistUser INT, @ValidPassword varchar(255), @PasswordMd5 varchar(255), @UserMd5 varchar(255), @Active Int

		SELECT @UserMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Email ), 2)
		SELECT @PasswordMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Password ), 2)
		SELECT @ExistUser = COUNT(1) FROM Users Where UserKey = @UserMd5
		SELECT @ValidPassword = Password  FROM Users WHERE UserKey = @UserMd5
		Select @Active = Active FROM Users WHERE UserKey = @UserMd5
			
	IF @ExistUser = 0
		BEGIN
			SET @Result = 'Error__El Email ingresado no Existe'
		END
	ELSE
		BEGIN	
			IF @ValidPassword = @PasswordMd5
				BEGIN
					IF @Active = 1
						BEGIN
							SET @Result = 'OK__'+@UserMd5
						END
					ELSE
						BEGIN
							SET @Result = 'Error__El Usuario se encuentra Inactivo, por favor realice una peticion en la Sección Contacto'
						END
				END
			ELSE
				BEGIN
					SET @Result = 'Error__Contraseña incorrecta'
				END
		END
	SELECT @Result
END

go

CREATE TABLE DocumentType
(Id int identity(1,1) Primary key,
Name varchar(255),
Activo int default 1,
unique(Name)
)

go

CREATE TABLE City
(Id int identity(1,1) Primary key ,
IdCountry int,
Name varchar(255),
Activo int default 1,
unique(Name)
)


ALTER TABLE City ADD CONSTRAINT FK_IdCountry FOREIGN KEY (IdCountry) references Country(Id)

go

CREATE TABLE PersonalInformation 
(Id int identity(1,1) Primary key ,
IdUser int,
FirstName varchar(255),
LastName varchar(255),
IdDocumentType int,
IdentificationNumber varchar(255),
Email varchar(255),
Phone varchar(255),
PhoneAdditional varchar(255),
BirthDate date,
IdNationality int,
ResidenceAdress varchar(255),
IdCity int,
UserImage varchar(255)
)

ALTER TABLE PersonalInformation ADD CONSTRAINT FK_UserKey FOREIGN KEY (IdUser) references Users(Id)
ALTER TABLE PersonalInformation ADD CONSTRAINT FK_IdDocumentType FOREIGN KEY (IdDocumentType) references DocumentType(Id)
ALTER TABLE PersonalInformation ADD CONSTRAINT FK_IdNationality FOREIGN KEY (IdNationality) references Country(Id)
ALTER TABLE PersonalInformation ADD CONSTRAINT FK_IdCity FOREIGN KEY (IdCity) references City(Id)